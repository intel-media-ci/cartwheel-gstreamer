From 6637c9b343bcefc060fcf003bd68432f491d0b56 Mon Sep 17 00:00:00 2001
From: Mengkejiergeli Ba <mengkejiergeli.ba@intel.com>
Date: Wed, 2 Jun 2021 15:26:25 +0800
Subject: [PATCH 3/6] msdkav1enc: add tile

---
 sys/msdk/gstmsdkav1enc.c | 67 +++++++++++++++++++++++++++++++++++++---
 sys/msdk/gstmsdkav1enc.h |  2 ++
 2 files changed, 65 insertions(+), 4 deletions(-)

diff --git a/sys/msdk/gstmsdkav1enc.c b/sys/msdk/gstmsdkav1enc.c
index c4c5337888..c31a395006 100644
--- a/sys/msdk/gstmsdkav1enc.c
+++ b/sys/msdk/gstmsdkav1enc.c
@@ -40,6 +40,15 @@
 GST_DEBUG_CATEGORY_EXTERN (gst_msdkav1enc_debug);
 #define GST_CAT_DEFAULT gst_msdkav1enc_debug
 
+enum
+{
+  PROP_TILE_ROW = GST_MSDKENC_PROP_MAX,
+  PROP_TILE_COL,
+};
+
+#define PROP_TILE_ROW_DEFAULT 1
+#define PROP_TILE_COL_DEFAULT 1
+
 #define RAW_FORMATS "NV12, I420, YV12, P010_10LE"
 #define PROFILES    "main"
 
@@ -148,6 +157,8 @@ gst_msdkav1enc_configure (GstMsdkEnc * encoder)
   av1enc->ext_av1.Header.BufferSz = sizeof (av1enc->ext_av1);
   av1enc->ext_av1.FrameWidth = encoder->param.mfx.FrameInfo.CropW;
   av1enc->ext_av1.FrameHeight = encoder->param.mfx.FrameInfo.CropH;
+  av1enc->ext_av1.NumTileRows = av1enc->num_tile_rows;
+  av1enc->ext_av1.NumTileColumns = av1enc->num_tile_cols;
   av1enc->ext_av1.PackOBUFrame = MFX_CODINGOPTION_OFF;
   av1enc->ext_av1.DisableFrameEndUpdateCdf = MFX_CODINGOPTION_OFF;
   av1enc->ext_av1.EnableCdef = MFX_CODINGOPTION_OFF;
@@ -200,8 +211,25 @@ gst_msdkav1enc_set_property (GObject * object, guint prop_id,
 {
   GstMsdkAV1Enc *thiz = GST_MSDKAV1ENC (object);
 
-  if (!gst_msdkenc_set_common_property (object, prop_id, value, pspec))
-    GST_WARNING_OBJECT (thiz, "Failed to set common encode property");
+  if (gst_msdkenc_set_common_property (object, prop_id, value, pspec))
+    return;
+
+  GST_OBJECT_LOCK (thiz);
+
+  switch (prop_id) {
+    case PROP_TILE_ROW:
+      thiz->num_tile_rows = g_value_get_uint (value);
+      break;
+
+    case PROP_TILE_COL:
+      thiz->num_tile_cols = g_value_get_uint (value);
+      break;
+
+    default:
+      G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
+      break;
+  }
+  GST_OBJECT_UNLOCK (thiz);
 }
 
 static void
@@ -210,8 +238,25 @@ gst_msdkav1enc_get_property (GObject * object, guint prop_id, GValue * value,
 {
   GstMsdkAV1Enc *thiz = GST_MSDKAV1ENC (object);
 
-  if (!gst_msdkenc_get_common_property (object, prop_id, value, pspec))
-    GST_WARNING_OBJECT (thiz, "Failed to get common encode property");
+  if (gst_msdkenc_get_common_property (object, prop_id, value, pspec))
+    return;
+
+  GST_OBJECT_LOCK (thiz);
+
+  switch (prop_id) {
+    case PROP_TILE_ROW:
+      g_value_set_uint (value, thiz->num_tile_rows);
+      break;
+
+    case PROP_TILE_COL:
+      g_value_set_uint (value, thiz->num_tile_cols);
+      break;
+
+    default:
+      G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
+      break;
+  }
+  GST_OBJECT_UNLOCK (thiz);
 }
 
 static void
@@ -234,6 +279,18 @@ gst_msdkav1enc_class_init (GstMsdkAV1EncClass * klass)
 
   gst_msdkenc_install_common_properties (encoder_class);
 
+  g_object_class_install_property (gobject_class, PROP_TILE_ROW,
+      g_param_spec_uint ("num-tile-rows", "number of rows for tiled encoding",
+          "number of rows for tiled encoding",
+          1, 8192, PROP_TILE_ROW_DEFAULT,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+
+  g_object_class_install_property (gobject_class, PROP_TILE_COL,
+      g_param_spec_uint ("num-tile-cols", "number of columns for tiled encoding",
+          "number of columns for tiled encoding",
+          1, 8192, PROP_TILE_COL_DEFAULT,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+
   gst_element_class_set_static_metadata (element_class,
       "Intel MSDK AV1 encoder",
       "Codec/Encoder/Video/Hardware",
@@ -247,4 +304,6 @@ gst_msdkav1enc_class_init (GstMsdkAV1EncClass * klass)
 static void
 gst_msdkav1enc_init (GstMsdkAV1Enc * thiz)
 {
+  thiz->num_tile_rows = PROP_TILE_ROW_DEFAULT;
+  thiz->num_tile_cols = PROP_TILE_COL_DEFAULT;
 }
diff --git a/sys/msdk/gstmsdkav1enc.h b/sys/msdk/gstmsdkav1enc.h
index 6ca7d63d44..72beefb811 100644
--- a/sys/msdk/gstmsdkav1enc.h
+++ b/sys/msdk/gstmsdkav1enc.h
@@ -56,6 +56,8 @@ struct _GstMsdkAV1Enc
   GstMsdkEnc base;
 
   gint profile;
+  gushort num_tile_rows;
+  gushort num_tile_cols;
 
   mfxExtAV1Param ext_av1;
   mfxExtAV1AuxData ext_av1_auxdata;
-- 
2.17.1

